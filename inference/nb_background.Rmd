---
title: "nb_background"
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This experiment evaluates the FDP and power of different approaches to detecting
interaction effects in negative binomially distributed data. It is inspired by
the 3 vs 3 differential expression simulation setup from the clipper paper, but
with interaction effects between pairs of factors.

### Data Generation

We use the fact that the NB distribution arises from a poisson-gamma mixture.
The idea is to generate sample $i$ for gene $j$ from
\begin{align*}
y_{ji} \sim \text{NB}\left(\mu_{j}, \mu_{j}^{-1}\right)
\mu_{j}\left(x\right) &= X \beta_{j} \\
\beta_{j} &\sim \text{Gamma}\left(\alpha_{j}, \lambda_{j})
\end{align*}
where $X$ is a design matrix with all the main and interaction effects. If there
is no true interaction effect, then the corresponding coordinate of $\beta_{j} =
0$. Notice that their is variation even among the null genes -- this is similar
to the heterogeneous effect idea in the clipper simulations.

Here are functions we use to generate these data.
```{r}
library(tidyverse)
library(DESeq2)
```

```{r}
simulate_means <- function(X, assignment, hyper) {
  result <- matrix(nrow = length(assignment), ncol = nrow(X))
  for (j in seq_along(assignment)) {
    beta <- rgamma(ncol(X), hyper$alpha, hyper$beta)
    if (assignment[j] == "null") {
      beta[hyper$null_ix] <- 0
    } 
    result[j, ] <- X %*% beta
  }
  
  result
}

simulate_data <- function(mu, delta = 0.1) {
  N <- ncol(mu)
  J <- nrow(mu)
  y <- matrix(0, J, N)
  
  for (i in seq_len(N)) {
    for (j in seq_len(J)) {
      y[j, i] <- rpois(1, mu[j, i])
      if (runif(1) < delta) {
        y[j, i] <- 0
      }
    }
  }
  
  y
}
```

```{r}
n_samples <- 4
n_features <- 3e3
n_sig <- 3e2

hyper <- list(alpha = 1, beta = .01, null_ix = 2)
X <- matrix(1, nrow = n_samples, ncol = 2)
X[1:(n_samples / 2), 2] <- 0
assignment <- c(rep("nonnull", n_sig), rep("null", n_features - n_sig))
mu <- simulate_means(X, assignment, hyper)
y <- simulate_data(mu)
```


```{r}
coldata <- as.data.frame(X) %>%
  set_names("intercept", "treatment") %>%
  mutate(treatment = as.factor(treatment))

dds <- DESeqDataSetFromMatrix(
  countData = y,
  colData = coldata, 
  design = ~ treatment
) %>%
  DESeq(fitType = "local") %>%
  results()
```
```{r}
hist(dds$pvalue)
```
```{r}
q <- 0.05
R <- which(dds$padj < q)
length(intersect(R, (n_sig + 1):n_features)) / length(R)
```